-- FixLag 50% (auto-run, client-side, non-destructive)
-- Mục tiêu: giảm ~50% load của particle/decals/lighting trên client
-- Paste vào LocalScript / executor rồi chơi thôi.

local Players = game:GetService("Players")
local Lighting = game:GetService("Lighting")
local player = Players.LocalPlayer

local TARGET_RATIO = 0.5 -- giữ 50% của hiệu ứng gốc
local BATCH_SIZE = 80
local PAUSE = 0.02

_G.__fixlag_backup = _G.__fixlag_backup or {}
local backup = _G.__fixlag_backup

local function safe(fn, ...)
    local ok, a, b = pcall(fn, ...)
    return ok, a, b
end

local function store(inst, key, value)
    if not inst then return end
    local id = tostring(inst:GetDebugId and inst:GetDebugId() or inst:GetFullName())
    backup[id] = backup[id] or {instRef = inst}
    backup[id][key] = value
end

local function applyTo(inst)
    if not inst or not inst.Parent then return end
    -- skip player's own character to avoid breaking controls/tools
    if player and player.Character and inst:IsDescendantOf(player.Character) then return end

    -- ParticleEmitter: reduce Rate
    if inst:IsA("ParticleEmitter") then
        safe(function()
            if inst:GetAttribute("__fix50_origRate") == nil then
                inst:SetAttribute("__fix50_origRate", inst.Rate)
                store(inst, "Rate", inst.Rate)
            end
            inst.Rate = (inst:GetAttribute("__fix50_origRate") or inst.Rate) * TARGET_RATIO
        end)
        return
    end

    -- Trail / Beam: try to reduce lifetime / disable if super heavy (best-effort)
    if inst:IsA("Trail") or inst:IsA("Beam") then
        safe(function()
            store(inst, "Enabled", inst.Enabled)
            -- gentle approach: keep them but try to shorten lifetimes if possible
            -- many Trails/Beams don't expose lifetime; fallback: if thick, disable
            if inst.Enabled then
                -- heuristic: if parts length large, disable; can't reliably measure, so keep enabled
                -- leave Enabled as-is but kept in backup
            end
        end)
        return
    end

    -- Decal / Texture: increase transparency proportionally
    if inst:IsA("Decal") or inst:IsA("Texture") then
        safe(function()
            local orig = inst.Transparency or 0
            store(inst, "Transparency", orig)
            local increase = (1 - TARGET_RATIO) -- 0.5
            local newT = orig + (1 - orig) * increase
            inst.Transparency = math.clamp(newT, 0, 1)
        end)
        return
    end
end

local function batchProcess(list)
    local n = #list
    local i = 1
    while i <= n do
        local to = math.min(n, i + BATCH_SIZE - 1)
        for j = i, to do
            local inst = list[j]
            applyTo(inst)
        end
        i = to + 1
        task.wait(PAUSE)
    end
end

local function applyLighting()
    safe(function()
        store(Lighting, "GlobalShadows", Lighting.GlobalShadows)
        store(Lighting, "Brightness", Lighting.Brightness)
        Lighting.GlobalShadows = false -- tiết kiệm ánh sáng
        Lighting.Brightness = math.max(0.3, Lighting.Brightness * 0.9) -- nhẹ nhàng giảm brightness
    end)
    -- try to set rendering quality (may be blocked by executor)
    pcall(function()
        if settings and settings().Rendering then
            store(settings().Rendering, "QualityLevel", settings().Rendering.QualityLevel)
            settings().Rendering.QualityLevel = 14 -- trung bình thấp
        end
    end)
end

-- main
local desc = workspace:GetDescendants()
batchProcess(desc)
applyLighting()

-- keep effect on new spawned client-side items
if _G.__fixlag_conn50 then
    pcall(function() _G.__fixlag_conn50:Disconnect() end)
end
_G.__fixlag_conn50 = workspace.DescendantAdded:Connect(function(inst)
    task.wait(0.03)
    applyTo(inst)
end)

-- provide a restore helper (optional) - không auto gọi
_G.__fixlag50_restore = function()
    if _G.__fixlag_conn50 then
        pcall(function() _G.__fixlag_conn50:Disconnect() end)
        _G.__fixlag_conn50 = nil
    end
    for id, info in pairs(backup) do
        local inst = info.instRef
        if inst and inst.Parent then
            pcall(function()
                if info.Rate and inst:IsA("ParticleEmitter") then inst.Rate = info.Rate end
                if info.Transparency and (inst:IsA("Decal") or inst:IsA("Texture")) then inst.Transparency = info.Transparency end
                if info.Enabled ~= nil and (inst:IsA("Trail") or inst:IsA("Beam") or inst:IsA("ParticleEmitter")) then inst.Enabled = info.Enabled end
            end)
        end
    end
    -- restore lighting
    pcall(function()
        if backup[tostring(Lighting)] and backup[tostring(Lighting)].Brightness then
            Lighting.Brightness = backup[tostring(Lighting)].Brightness
        elseif backup["Lighting"] and backup["Lighting"].Brightness then
            Lighting.Brightness = backup["Lighting"].Brightness
        end
        if backup[tostring(Lighting)] and backup[tostring(Lighting)].GlobalShadows ~= nil then
            Lighting.GlobalShadows = backup[tostring(Lighting)].GlobalShadows
        end
    end)
end

print("FixLag 50% applied (auto). To restore (if needed) call: _G.__fixlag50_restore()")
