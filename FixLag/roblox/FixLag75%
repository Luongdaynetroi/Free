-- FixLag 75% (auto-run, client-side, more aggressive)
-- Mục tiêu: giảm ~75% load (mạnh hơn) — cho máy rất yếu
-- Paste vào LocalScript / executor

local Players = game:GetService("Players")
local Lighting = game:GetService("Lighting")
local player = Players.LocalPlayer

local TARGET_RATIO = 0.25 -- giữ 25% của hiệu ứng gốc => ~75% reduction
local BATCH_SIZE = 70
local PAUSE = 0.018

_G.__fixlag_backup = _G.__fixlag_backup or {}
local backup = _G.__fixlag_backup

local function safe(fn, ...) local ok, a, b = pcall(fn, ...) return ok, a, b end
local function store(inst, key, value)
    if not inst then return end
    local id = tostring(inst:GetDebugId and inst:GetDebugId() or inst:GetFullName())
    backup[id] = backup[id] or {instRef = inst}
    backup[id][key] = value
end

local function applyTo(inst)
    if not inst or not inst.Parent then return end
    if player and player.Character and inst:IsDescendantOf(player.Character) then return end

    -- ParticleEmitter: aggressive reduce or disable if can't set rate
    if inst:IsA("ParticleEmitter") then
        safe(function()
            if inst:GetAttribute("__fix75_origRate") == nil then
                inst:SetAttribute("__fix75_origRate", inst.Rate)
                store(inst, "Rate", inst.Rate)
            end
            local ok = pcall(function()
                inst.Rate = (inst:GetAttribute("__fix75_origRate") or inst.Rate) * TARGET_RATIO
            end)
            if not ok then
                store(inst, "Enabled", inst.Enabled)
                inst.Enabled = false -- fallback: disable
            end
        end)
        return
    end

    -- Trail / Beam: disable (aggressive)
    if inst:IsA("Trail") or inst:IsA("Beam") then
        safe(function()
            store(inst, "Enabled", inst.Enabled)
            inst.Enabled = false
        end)
        return
    end

    -- Decal / Texture: ramp transparency up strongly
    if inst:IsA("Decal") or inst:IsA("Texture") then
        safe(function()
            local orig = inst.Transparency or 0
            store(inst, "Transparency", orig)
            local increase = (1 - TARGET_RATIO) -- 0.75
            local newT = orig + (1 - orig) * increase
            inst.Transparency = math.clamp(newT, 0, 1)
        end)
        return
    end

    -- BasePart: set cheap material (avoid character parts)
    if inst:IsA("BasePart") and not inst:IsDescendantOf(player.Character) then
        safe(function()
            store(inst, "Material", inst.Material)
            store(inst, "Reflectance", inst.Reflectance)
            inst.Material = Enum.Material.Plastic
            inst.Reflectance = 0
        end)
    end
end

local function batchProcess(list)
    local n = #list
    local i = 1
    while i <= n do
        local to = math.min(n, i + BATCH_SIZE - 1)
        for j = i, to do
            local inst = list[j]
            applyTo(inst)
        end
        i = to + 1
        task.wait(PAUSE)
    end
end

local function applyLighting()
    safe(function()
        store(Lighting, "GlobalShadows", Lighting.GlobalShadows)
        store(Lighting, "Brightness", Lighting.Brightness)
        store(Lighting, "EnvironmentDiffuseScale", Lighting.EnvironmentDiffuseScale)
        store(Lighting, "EnvironmentSpecularScale", Lighting.EnvironmentSpecularScale)

        Lighting.GlobalShadows = false
        Lighting.Brightness = math.max(0.2, Lighting.Brightness * 0.7) -- giảm mạnh hơn
        Lighting.EnvironmentDiffuseScale = 0
        Lighting.EnvironmentSpecularScale = 0
        Lighting.FogStart = 1e9
        Lighting.FogEnd = 1e9
    end)
    pcall(function()
        if settings and settings().Rendering then
            store(settings().Rendering, "QualityLevel", settings().Rendering.QualityLevel)
            settings().Rendering.QualityLevel = 7 -- low
        end
    end)
end

-- main
local desc = workspace:GetDescendants()
batchProcess(desc)
applyLighting()

if _G.__fixlag_conn75 then
    pcall(function() _G.__fixlag_conn75:Disconnect() end)
end
_G.__fixlag_conn75 = workspace.DescendantAdded:Connect(function(inst)
    task.wait(0.02)
    applyTo(inst)
end)

-- restore helper (optional)
_G.__fixlag75_restore = function()
    if _G.__fixlag_conn75 then
        pcall(function() _G.__fixlag_conn75:Disconnect() end)
        _G.__fixlag_conn75 = nil
    end
    for id, info in pairs(backup) do
        local inst = info.instRef
        if inst and inst.Parent then
            pcall(function()
                if info.Rate and inst:IsA("ParticleEmitter") then inst.Rate = info.Rate end
                if info.Enabled ~= nil and (inst:IsA("Trail") or inst:IsA("Beam") or inst:IsA("ParticleEmitter")) then inst.Enabled = info.Enabled end
                if info.Transparency and (inst:IsA("Decal") or inst:IsA("Texture")) then inst.Transparency = info.Transparency end
                if info.Material and inst:IsA("BasePart") then inst.Material = info.Material end
                if info.Reflectance and inst:IsA("BasePart") then inst.Reflectance = info.Reflectance end
            end)
        end
    end
    -- restore lighting (best-effort)
    pcall(function()
        if backup[tostring(Lighting)] and backup[tostring(Lighting)].Brightness then
            Lighting.Brightness = backup[tostring(Lighting)].Brightness
        end
        if backup[tostring(Lighting)] and backup[tostring(Lighting)].GlobalShadows ~= nil then
            Lighting.GlobalShadows = backup[tostring(Lighting)].GlobalShadows
        end
    end)
end

print("FixLag 75% applied (auto). To restore (if needed) call: _G.__fixlag75_restore()")
