--========================================================
-- DucLuongg Farm-Fix™ — "Dân Cày" Edition
-- Giữ UI + Quái/NPC + Hệ thống. Xóa đảo, decor, effect nặng.
-- Chạy client-side (executor / loadstring).
-- Trước khi chạy: thêm object quan trọng vào _G.Ignore = {workspace.Map, workspace.IslandA}
--========================================================

-- ===== CONFIG (SỬA nếu muốn)
if not _G.Ignore then _G.Ignore = {} end   -- những Instance hoặc Models bạn muốn bảo vệ (để tránh bị xóa)
local CFG = {
    NAME = "DucLuongg Farm-Fix",
    NOTIFY = true,            -- hiện notification khi load
    LOG = false,              -- warn() nhiều hơn
    DESTROY_ISLANDS = true,   -- có xóa islands/large models ko
    ISLAND_MIN_VOLUME = 20000,-- threshold để đánh dấu "đảo" (tăng nếu map lớn)
    SIMPLIFY_ONLY = false,    -- nếu true thì không destroy island mà chỉ rút gọn (mesh->blank, texture->blank)
    DISABLE_PARTICLES = true, -- tắt particle/trail/sparkles
    MINIMIZE_POST = true,     -- disable bloom/sun/blur nếu có
    SET_MATERIAL_PLASTIC = true, -- force các part về Plastic
    SET_RENDERFIDELITY = true, -- set MeshPart.RenderFidelity = Performance
    SAFE_PROTECT_HUMANOID = true, -- không động vào models có Humanoid
}

-- ===== services
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local Lighting = game:GetService("Lighting")
local StarterGui = game:GetService("StarterGui")
local MaterialService = game:GetService("MaterialService")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer

-- ===== helpers
local function notify(txt, dur)
    if CFG.NOTIFY then
        pcall(function()
            StarterGui:SetCore("SendNotification", {Title = CFG.NAME, Text = txt, Duration = dur or 4})
        end)
    end
    if CFG.LOG then warn("[Farm-Fix] "..tostring(txt)) end
end

local function isInIgnore(inst)
    if not inst then return false end
    for _,v in pairs(_G.Ignore) do
        if v and inst:IsDescendantOf(v) then return true end
    end
    return false
end

local function hasHumanoidAncestor(inst)
    local a = inst
    while a and a.Parent do
        if a:FindFirstChildOfClass and a:FindFirstChildOfClass("Humanoid") then return true end
        a = a.Parent
    end
    return false
end

local function isPlayerDescendant(inst)
    if not inst then return false end
    for _,p in pairs(Players:GetPlayers()) do
        if p.Character and inst:IsDescendantOf(p.Character) then return true end
    end
    return false
end

local safeSkipClasses = {
    Script = true, LocalScript = true, ModuleScript = true,
    RemoteEvent = true, RemoteFunction = true,
    BindableEvent = true, BindableFunction = true,
    Animation = true, Animator = true
}
local function isSystemClass(inst)
    if not inst then return false end
    return safeSkipClasses[inst.ClassName] == true
end

-- compute approx "volume" of a Model (sum of part sizes)
local function modelVolume(model)
    if not model or not model:GetChildren then return 0 end
    local vol = 0
    for _,part in pairs(model:GetDescendants()) do
        if part:IsA("BasePart") then
            local s = part.Size
            vol = vol + (s.X * s.Y * s.Z)
        end
    end
    return vol
end

-- decide if a model is "island-like"
local function isLikelyIsland(model)
    if not model or not model:IsA("Model") then return false end
    if isInIgnore(model) then return false end
    if CFG.SAFE_PROTECT_HUMANOID and model:FindFirstChildOfClass("Humanoid") then return false end
    if model:FindFirstChildWhichIsA("Script") or model:FindFirstChildWhichIsA("ModuleScript") or model:FindFirstChildWhichIsA("RemoteEvent") then
        -- nếu có script/remote, khả năng là game system → skip
        return false
    end
    local vol = modelVolume(model)
    if vol >= CFG.ISLAND_MIN_VOLUME then
        return true
    end
    -- also consider name heuristics
    local name = (model.Name or ""):lower()
    if name:match("island") or name:match("map") or name:match("terrain") or name:match("stage") then
        return true
    end
    return false
end

-- safe simplification for Parts/MeshParts/Decals/Particles
local function simplifyInstance(inst)
    if not inst or not inst.Parent then return end
    if isInIgnore(inst) then return end
    if isSystemClass(inst) then return end
    if inst:IsDescendantOf(game:GetService("CoreGui")) then return end
    if isPlayerDescendant(inst) then return end
    if CFG.SAFE_PROTECT_HUMANOID and hasHumanoidAncestor(inst) then return end

    local ok,err
    -- Part / MeshPart
    if inst:IsA("MeshPart") or inst:IsA("BasePart") then
        pcall(function()
            if CFG.SET_RENDERFIDELITY and inst:IsA("MeshPart") then
                inst.RenderFidelity = Enum.RenderFidelity.Performance
            end
            if CFG.SET_MATERIAL_PLASTIC then
                inst.Material = Enum.Material.Plastic
                inst.Reflectance = 0
                inst.CastShadow = false
            end
            -- small transparency so player can still see shapes (xi măng effect)
            if inst:IsA("BasePart") and not inst:IsDescendantOf(LocalPlayer.PlayerGui or {}) then
                if inst.Transparency < 0.15 then inst.Transparency = 0.12 end
            end
        end)
    end

    -- Decal/Texture/SurfaceAppearance
    if inst:IsA("Decal") or inst:IsA("Texture") then
        pcall(function()
            inst.Transparency = math.max(0.2, inst.Transparency or 0)
            if CFG.SIMPLIFY_ONLY then
                -- keep but desaturate via transparency
            else
                inst.Texture = "" -- blank texture -> nhẹ
            end
        end)
    end

    if inst:IsA("SurfaceAppearance") then
        pcall(function()
            if not CFG.SIMPLIFY_ONLY then
                inst:Destroy()
            end
        end)
    end

    -- Particles / Trails / Sparkles / Fire / Smoke
    if (inst:IsA("ParticleEmitter") or inst:IsA("Trail") or inst:IsA("Sparkles") or inst:IsA("Fire") or inst:IsA("Smoke")) and CFG.DISABLE_PARTICLES then
        pcall(function()
            -- keep if attached to player character (player VFX)
            if isPlayerDescendant(inst) or hasHumanoidAncestor(inst) then
                -- preserve
            else
                if inst:IsA("ParticleEmitter") then
                    inst.Rate = 0
                    inst.Lifetime = NumberRange.new(0.03)
                    inst.Speed = NumberRange.new(0)
                    inst.Enabled = false
                else
                    inst.Enabled = false
                end
            end
        end)
    end

    -- Explosion
    if inst:IsA("Explosion") then
        pcall(function()
            inst.BlastPressure = 0
            inst.BlastRadius = 0
            inst.Visible = false
        end)
    end

    -- PostEffects (do not destroy critical ones, but tone down)
    if CFG.MINIMIZE_POST and inst:IsA("PostEffect") then
        pcall(function()
            local cls = inst.ClassName
            if cls == "BloomEffect" then inst.Intensity = math.min(inst.Intensity or 0.8, 0.5) end
            if cls == "SunRaysEffect" then inst.Intensity = math.min(inst.Intensity or 0.2, 0.08) end
            if cls == "DepthOfFieldEffect" or cls == "BlurEffect" or cls == "ColorCorrectEffect" then
                -- keep CC but reduce heavy params
                if cls == "ColorCorrectionEffect" then
                    inst.Saturation = math.min(inst.Saturation or 0.2, 0.12)
                elseif cls == "DepthOfFieldEffect" or cls == "BlurEffect" then
                    -- disable heavy DOF/Blur
                    inst.Enabled = false
                end
            end
        end)
    end
end

-- main island destroy/simplify
local function handleModel(model)
    if not model or not model.Parent then return end
    if isInIgnore(model) then return end
    if isPlayerDescendant(model) then return end
    if CFG.SAFE_PROTECT_HUMANOID and model:FindFirstChildOfClass("Humanoid") then return end
    if isLikelyIsland(model) then
        if CFG.DESTROY_ISLANDS and not CFG.SIMPLIFY_ONLY then
            pcall(function() model:Destroy() end)
            if CFG.LOG then warn("Destroyed island-like model: "..tostring(model:GetFullName())) end
            return
        else
            -- simplify contents instead of destroy
            for _,child in pairs(model:GetDescendants()) do
                pcall(simplifyInstance, child)
            end
            if CFG.LOG then warn("Simplified island model: "..tostring(model:GetFullName())) end
        end
    end
end

-- apply simplification to every instance (safe)
local function applyGlobalPass()
    for _,inst in pairs(Workspace:GetDescendants()) do
        -- skip system classes and UI
        if inst:IsDescendantOf(game:GetService("CoreGui")) then
            -- ignore
        elseif inst:IsDescendantOf(LocalPlayer and LocalPlayer:FindFirstChild("PlayerGui") or {}) then
            -- keep UI
        elseif inst.Parent then
            -- if it's a top-level model, test island
            local top = inst
            while top and top.Parent and not top:IsA("Model") do top = top.Parent end
            if top and top ~= Workspace and top:IsA("Model") then
                handleModel(top)
            else
                pcall(simplifyInstance, inst)
            end
        end
    end
end

-- Hook new objects
Workspace.DescendantAdded:Connect(function(inst)
    task.wait(0.03)
    -- immediate protection: if new model likely island, handle it
    if inst:IsA("Model") then
        pcall(handleModel, inst)
    else
        pcall(simplifyInstance, inst)
    end
end)

-- small lighting/terrain tweaks (non-destructive)
pcall(function()
    if CFG.MINIMIZE_POST then
        for _,v in pairs(Lighting:GetChildren()) do
            if v:IsA("PostEffect") then
                pcall(function()
                    if v.ClassName == "DepthOfFieldEffect" or v.ClassName == "BlurEffect" then v.Enabled = false end
                    if v.ClassName == "SunRaysEffect" then v.Intensity = math.min(v.Intensity or 0.2, 0.08) end
                    if v.ClassName == "BloomEffect" then v.Intensity = math.min(v.Intensity or 0.8, 0.5) end
                end)
            end
        end
    end

    local terrain = Workspace:FindFirstChildOfClass("Terrain")
    if terrain then
        pcall(function()
            terrain.WaterWaveSize = 0
            terrain.WaterWaveSpeed = 0
            terrain.WaterReflectance = 0
            terrain.WaterTransparency = 0
            if sethiddenproperty then pcall(sethiddenproperty, terrain, "Decoration", false) end
        end)
    end

    if CFG.SET_MATERIAL_PLASTIC then
        pcall(function()
            for _,m in pairs(MaterialService:GetChildren()) do pcall(function() m:Destroy() end) end
            MaterialService.Use2022Materials = false
        end)
    end
end)

-- set general rendering to performance-ish
pcall(function()
    settings().Rendering.QualityLevel = Enum.QualityLevel.Level02
    Lighting.GlobalShadows = false
    Lighting.FogEnd = 9e9
end)

-- run full pass
applyGlobalPass()

-- notify
notify("Farm-Fix: tối ưu xong. UI & NPC giữ nguyên. Nếu cần bảo toàn island/map: thêm vào _G.Ignore rồi re-run.", 6)
if CFG.LOG then print("Farm-Fix config:", CFG) end

-- convenience: expose quick restore hint (not an auto-restore)
print("[Farm-Fix] Loaded. To protect an object from being removed, run: table.insert(_G.Ignore, workspace.TheModel) and re-run.")

-- EOF
