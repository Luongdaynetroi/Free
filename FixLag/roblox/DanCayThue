-- ==========================
-- FIXLAG FARMER MODE - AUTO RUN
-- Non-destructive as much as possible: set transparency/color to grayscale, disable heavy particles
-- Keep UI, NPC (Humanoid), quest systems
-- ==========================

-- CONFIG
local BATCH_SIZE = 90
local SLEEP_TIME = 0.015
local TARGET_DECAL_TRANSPARENCY = 1.0  -- decal -> fully invisible (but not destroyed)
local TARGET_PART_COLOR = Color3.fromRGB(160,160,160) -- neutral gray
local PARTICLE_RATE_RATIO = 0.18  -- reduce particle rates to ~18%
local DEBUG = true

local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local Lighting = game:GetService("Lighting")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local CollectionService = game:GetService("CollectionService")
local player = Players.LocalPlayer

_G.__fixFarmer_backup = _G.__fixFarmer_backup or {}
local backup = _G.__fixFarmer_backup

local function log(...)
    if not DEBUG then return end
    pcall(function() print("[FixFarmer] ", ...) end)
end

local function safe(fn, ...)
    local ok, res = pcall(fn, ...)
    return ok, res
end

-- whitelist heuristic (stronger than Fix100: keep NPCs, keep anything with "Quest" in name)
local function isFarmWhitelist(inst)
    if not inst then return false end
    if inst:IsDescendantOf(player:FindFirstChild("PlayerGui") or {}) then return true end
    if player.Character and inst:IsDescendantOf(player.Character) then return true end
    if inst:IsDescendantOf(ReplicatedStorage) then return true end

    local model = inst
    while model and not model:IsA("Model") do model = model.Parent end
    if model and model:IsA("Model") then
        if model:FindFirstChildOfClass("Humanoid") or model:FindFirstChild("HumanoidRootPart") then
            return true
        end
        local nm = tostring(model.Name):lower()
        if nm:find("npc") or nm:find("enemy") or nm:find("mob") or nm:find("boss") or nm:find("quest") then
            return true
        end
    end

    if CollectionService and CollectionService:HasTag(inst, "Keep") then return true end

    if inst:IsA("BillboardGui") or inst:IsA("SurfaceGui") then
        local name = tostring(inst.Name):lower()
        if name:find("quest") or name:find("ui") or name:find("hud") or name:find("target") then
            return true
        end
    end

    return false
end

-- store backup
local function storeBackup(inst, key, value)
    if not inst then return end
    local id = tostring(inst:GetDebugId and inst:GetDebugId() or inst:GetFullName())
    backup[id] = backup[id] or {instRef = inst}
    backup[id][key] = value
end

-- Apply farmer-mode changes (non-destructive where possible)
local function applyFarmer(inst)
    if not inst or not inst.Parent then return end
    if isFarmWhitelist(inst) then return end

    -- Particle emitters -> reduce rate (backup)
    if inst:IsA("ParticleEmitter") then
        safe(function()
            storeBackup(inst, "Rate", inst.Rate)
            storeBackup(inst, "Enabled", inst.Enabled)
            -- attempt to set Rate to small ratio
            local ok = pcall(function()
                inst.Rate = (inst.Rate or 1) * PARTICLE_RATE_RATIO
            end)
            if not ok then
                pcall(function() inst.Enabled = false end)
            end
        end)
        return
    end

    -- Trail / Beam -> reduce / keep enabled but attempt to shorten appearance
    if inst:IsA("Trail") or inst:IsA("Beam") then
        safe(function()
            storeBackup(inst, "Enabled", inst.Enabled)
            -- try to nudge lifetime-relevant properties if exist (best-effort)
            pcall(function() inst.Enabled = false end) -- safer to disable for performance
        end)
        return
    end

    -- Decal / Texture -> make invisible (do not destroy)
    if inst:IsA("Decal") or inst:IsA("Texture") then
        safe(function()
            storeBackup(inst, "Transparency", inst.Transparency)
            inst.Transparency = math.max(inst.Transparency or 0, TARGET_DECAL_TRANSPARENCY)
        end)
        return
    end

    -- SurfaceAppearance: remove maps if possible (best-effort, non-destroy)
    if inst:IsA("SurfaceAppearance") then
        safe(function()
            storeBackup(inst, "ColorMap", inst.ColorMap)
            storeBackup(inst, "NormalMap", inst.NormalMap)
            -- try to clear references (non-destructive), some executors may block property writes
            pcall(function() inst.ColorMap = "" end)
            pcall(function() inst.NormalMap = "" end)
        end)
        return
    end

    -- BasePart: set to gray + plastic (keep collision/hitbox)
    if inst:IsA("BasePart") then
        safe(function()
            if player.Character and inst:IsDescendantOf(player.Character) then return end
            storeBackup(inst, "Material", inst.Material)
            storeBackup(inst, "Color", inst.Color)
            storeBackup(inst, "Reflectance", inst.Reflectance)
            storeBackup(inst, "Transparency", inst.Transparency)
            inst.Material = Enum.Material.Plastic
            inst.Color = TARGET_PART_COLOR
            inst.Reflectance = 0
            -- keep Transparency as-is (so invisible gates / triggers remain)
        end)
        return
    end

    -- SpecialMesh: clear textureId
    if inst:IsA("SpecialMesh") then
        safe(function()
            storeBackup(inst, "TextureId", inst.TextureId)
            pcall(function() inst.TextureId = "" end)
        end)
        return
    end

    -- GUI-like attachments in world: hide heavy images
    if inst:IsA("BillboardGui") or inst:IsA("SurfaceGui") then
        safe(function()
            for _,c in ipairs(inst:GetDescendants()) do
                if c:IsA("ImageLabel") or c:IsA("ImageButton") or c:IsA("VideoFrame") then
                    storeBackup(c, "Visible", c.Visible)
                    pcall(function() c.Visible = false end)
                end
            end
        end)
        return
    end
end

-- batch processor
local function batchProcess(list, fn, batchSize, sleepTime)
    batchSize = batchSize or BATCH_SIZE
    sleepTime = sleepTime or SLEEP_TIME
    local n = #list
    local i = 1
    while i <= n do
        local to = math.min(n, i + batchSize - 1)
        for j = i, to do
            local inst = list[j]
            fn(inst)
        end
        i = to + 1
        task.wait(sleepTime)
    end
end

-- Lighting + color correction to grayscale
local function applyLightingAndCC()
    safe(function()
        -- Add ColorCorrectionEffect if not present
        local existing = Lighting:FindFirstChild("FixFarmerColorCorrection")
        if not existing then
            local cc = Instance.new("ColorCorrectionEffect")
            cc.Name = "FixFarmerColorCorrection"
            cc.Saturation = -1
            cc.Contrast = 0.05
            cc.Brightness = 0
            cc.Parent = Lighting
            storeBackup(Lighting, "HadColorCorrection", true)
        end
        -- adjust lighting to be simple
        storeBackup(Lighting, "GlobalShadows", Lighting.GlobalShadows)
        storeBackup(Lighting, "Brightness", Lighting.Brightness)
        Lighting.GlobalShadows = false
        Lighting.Brightness = math.max(0.7, Lighting.Brightness * 0.9)
    end)
    safe(function()
        if settings and settings().Rendering then
            storeBackup(settings().Rendering, "QualityLevel", settings().Rendering.QualityLevel)
            settings().Rendering.QualityLevel = math.clamp(7, 1, 21) -- moderate low
        end
    end)
end

-- run pass
log("Starting Farmer Mode pass...")
local all = Workspace:GetDescendants()
batchProcess(all, applyFarmer)
applyLightingAndCC()

-- keep effect on new objects
if _G.__fixFarmer_conn then
    pcall(function() _G.__fixFarmer_conn:Disconnect() end)
end
_G.__fixFarmer_conn = Workspace.DescendantAdded:Connect(function(inst)
    task.wait(0.03)
    pcall(function() applyFarmer(inst) end)
end)

-- restore helper
_G.__fixFarmer_restore = function()
    pcall(function()
        if _G.__fixFarmer_conn then
            _G.__fixFarmer_conn:Disconnect()
            _G.__fixFarmer_conn = nil
        end
        for id,info in pairs(backup) do
            local inst = info.instRef
            if inst and inst.Parent then
                pcall(function()
                    if info.Rate and inst:IsA("ParticleEmitter") then inst.Rate = info.Rate end
                    if info.Enabled ~= nil and (inst:IsA("ParticleEmitter") or inst:IsA("Trail") or inst:IsA("Beam")) then inst.Enabled = info.Enabled end
                    if info.Transparency and inst:IsA("Decal") then inst.Transparency = info.Transparency end
                    if info.Color and inst:IsA("BasePart") then inst.Color = info.Color end
                    if info.Material and inst:IsA("BasePart") then inst.Material = info.Material end
                    if info.TextureId and inst:IsA("SpecialMesh") then inst.TextureId = info.TextureId end
                    if info.Visible ~= nil and inst:IsA("GuiObject") then inst.Visible = info.Visible end
                end)
            end
        end
        -- remove color correction
        pcall(function() local cc = Lighting:FindFirstChild("FixFarmerColorCorrection") if cc then cc:Destroy() end end)
        -- restore lighting fields
        pcall(function()
            if backup[tostring(Lighting)] and backup[tostring(Lighting)].Brightness then
                Lighting.Brightness = backup[tostring(Lighting)].Brightness
            end
            if backup[tostring(Lighting)] and backup[tostring(Lighting)].GlobalShadows ~= nil then
                Lighting.GlobalShadows = backup[tostring(Lighting)].GlobalShadows
            end
            if settings and settings().Rendering and backup[ tostring(settings().Rendering) ] and backup[ tostring(settings().Rendering) ].QualityLevel then
                settings().Rendering.QualityLevel = backup[ tostring(settings().Rendering) ].QualityLevel
            end
        end)
    end)
    log("Farmer Mode restore attempted (best-effort).")
end

log("FixFarmer applied. To restore, call: _G.__fixFarmer_restore()")
