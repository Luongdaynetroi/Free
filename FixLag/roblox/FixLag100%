-- DucLuongg FixLag™ — 100% Edition (Ultra)
-- CỰC KÍ TIẾT KIỆM: nhiều thứ được clear/turned-off. Bảo đảm thêm vào _G.Ignore cho map/NPC quan trọng trước khi chạy.

if not _G.Ignore then _G.Ignore = {} end
local CONFIG = {
    NAME = "FixLag100",
    LOCK_FPS = 60, -- lower cap để giảm render
    STRIP_MESHES = true,
    STRIP_TEXTURES = true,
    DISABLE_PARTICLES = true,
    DISABLE_POST = true,
    FORCE_PLASTIC = true,
    PROTECT_PLAYERS = true,
    PROTECT_NPCS_WITH_HUMANOID = true,
}

local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local Lighting = game:GetService("Lighting")
local MaterialService = game:GetService("MaterialService")
local StarterGui = game:GetService("StarterGui")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer

local function notify(t) pcall(function() StarterGui:SetCore("SendNotification",{Title="DucLuongg FixLag100",Text=t,Duration=6}) end) end

local function isIgnored(inst)
    if not inst then return false end
    for _,v in pairs(_G.Ignore) do if v and inst:IsDescendantOf(v) then return true end end
    return false
end

local function ancestorHasHumanoid(inst)
    local a = inst
    while a and a.Parent do
        if a:FindFirstChildOfClass and a:FindFirstChildOfClass("Humanoid") then return true end
        a = a.Parent
    end
    return false
end

local function protected(inst)
    if not inst then return true end
    if isIgnored(inst) then return true end
    if CONFIG.PROTECT_PLAYERS and inst:IsDescendantOf(Players) then return true end
    if CONFIG.PROTECT_NPCS_WITH_HUMANOID and ancestorHasHumanoid(inst) then return true end
    if inst:IsDescendantOf(game:GetService("CoreGui")) then return true end
    if LocalPlayer and LocalPlayer:FindFirstChild("PlayerGui") and inst:IsDescendantOf(LocalPlayer.PlayerGui) then return true end
    return false
end

local function ultraOptimize(inst)
    if not inst or not inst.Parent then return end
    if protected(inst) then return end

    -- remove meshes/textures (non-destructive: blank ids)
    if CONFIG.STRIP_MESHES and inst:IsA("SpecialMesh") then
        pcall(function() inst.MeshId = "" end)
    end
    if CONFIG.STRIP_TEXTURES and inst:IsA("Decal") then
        pcall(function() inst.Texture = "" end)
    end
    if CONFIG.FORCE_PLASTIC and inst:IsA("BasePart") then
        pcall(function() inst.Material = Enum.Material.Plastic; inst.Reflectance = 0; inst.CastShadow = false end)
    end
    if inst:IsA("MeshPart") then
        pcall(function() inst.MeshId = ""; inst.TextureID = ""; inst.RenderFidelity = Enum.RenderFidelity.Performance; inst.Material = Enum.Material.Plastic; inst.CastShadow = false end)
    end

    -- disable any particle/trail/explosion
    if CONFIG.DISABLE_PARTICLES then
        if inst:IsA("ParticleEmitter") or inst:IsA("Trail") or inst:IsA("Fire") or inst:IsA("Smoke") or inst:IsA("Sparkles") then
            pcall(function() inst.Enabled = false end)
        elseif inst:IsA("Explosion") then
            pcall(function() inst.BlastPressure = 0; inst.BlastRadius = 0; inst.Visible = false end)
        end
    end

    -- destroy non-critical post effects
    if CONFIG.DISABLE_POST and inst:IsA("PostEffect") then
        pcall(function() inst:Destroy() end)
    end

    -- clothing / appearances - remove to save drawcalls (but protect players/NPCs)
    if inst:IsA("Clothing") or inst:IsA("SurfaceAppearance") or inst:IsA("BaseWrap") then
        pcall(function() inst:Destroy() end)
    end
end

-- apply once
for _,v in pairs(workspace:GetDescendants()) do pcall(ultraOptimize,v) end
Workspace.DescendantAdded:Connect(function(v) task.wait(0.03); pcall(ultraOptimize,v) end)

-- global settings
pcall(function()
    settings().Rendering.QualityLevel = Enum.QualityLevel.Level01
    Lighting.GlobalShadows = false
    Lighting.FogEnd = 1e9
    Lighting.Brightness = math.max(Lighting.Brightness, 2.0)
    Lighting.OutdoorAmbient = Color3.fromRGB(120,120,120)
end)

-- terrain water
pcall(function()
    local t = workspace:FindFirstChildOfClass("Terrain")
    if t then t.WaterWaveSize = 0; t.WaterWaveSpeed = 0; t.WaterReflectance = 0; t.WaterTransparency = 0; if sethiddenproperty then pcall(sethiddenproperty,t,"Decoration",false) end end
end)

-- destroy MaterialService materials to fallback simple
pcall(function()
    for _,m in pairs(MaterialService:GetChildren()) do pcall(function() m:Destroy() end) end
    pcall(function() MaterialService.Use2022Materials = false end)
end)

-- setfpscap
if CONFIG.LOCK_FPS and type(CONFIG.LOCK_FPS) == "number" and setfpscap then
    pcall(function() setfpscap(CONFIG.LOCK_FPS) end)
end

notify("FixLag 100% applied — cực kỳ nhẹ. Nếu mất thứ cần thiết: put it into _G.Ignore và reconnect.", 8)
print("DucLuongg FixLag100 loaded.")
